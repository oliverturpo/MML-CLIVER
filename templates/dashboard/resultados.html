{% extends 'dashboard/base_dashboard.html' %}

{% block page_title %}Resultados{% endblock %}
{% block page_subtitle %}Análisis y visualización de métricas del modelo{% endblock %}

{% block content %}
<!-- Model Performance Overview -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Main Performance Card -->
    <div class="lg:col-span-2 bg-gradient-to-br from-blue-500 to-purple-600 text-white rounded-2xl p-8 relative overflow-hidden">
        <div class="absolute top-0 right-0 opacity-20">
            <i class="fas fa-chart-line text-8xl transform rotate-12"></i>
        </div>
        <div class="relative z-10">
            <h2 class="text-3xl font-bold mb-4">Rendimiento del Modelo</h2>
            <p class="text-white/90 text-lg mb-6">
                {% if perfil.tiene_modelo_entrenado %}
                    Tu modelo {{ perfil.get_algoritmo_elegido_display }} ha sido entrenado exitosamente.
                {% else %}
                    Entrena tu modelo para ver los resultados aquí.
                {% endif %}
            </p>
            {% if not perfil.tiene_modelo_entrenado %}
                <a href="{% url 'dashboard_modelo' perfil.id %}" class="bg-white/20 text-white px-6 py-2 rounded-lg hover:bg-white/30 transition-colors">
                    <i class="fas fa-play mr-2"></i>Entrenar Modelo
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Model Status -->
    <div class="space-y-4">
        <div class="bg-white rounded-xl p-6 shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Estado del Modelo</p>
                    <p class="text-lg font-semibold text-gray-800">
                        {% if perfil.tiene_modelo_entrenado %}
                            <span class="text-green-600">Entrenado</span>
                        {% else %}
                            <span class="text-orange-600">Pendiente</span>
                        {% endif %}
                    </p>
                </div>
                <div class="w-16 h-16 rounded-full flex items-center justify-center
                    {% if perfil.tiene_modelo_entrenado %}bg-gradient-to-r from-green-400 to-green-500{% else %}bg-gradient-to-r from-orange-400 to-orange-500{% endif %}">
                    <i class="fas {% if perfil.tiene_modelo_entrenado %}fa-check{% else %}fa-clock{% endif %} text-white text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Tiempo Entrenamiento</p>
                    <p class="text-lg font-semibold text-gray-800">
                        {{ perfil.tiempo_entrenamiento|default:"--:--" }}
                    </p>
                </div>
                <div class="w-16 h-16 bg-gradient-to-r from-blue-400 to-indigo-500 rounded-full flex items-center justify-center">
                    <i class="fas fa-stopwatch text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>
</div>

{% if perfil.metricas %}
<!-- Variable Explanation -->
{% if perfil.metricas.target_column %}
<div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-6 mb-8">
    <h3 class="text-lg font-bold text-indigo-900 mb-4 flex items-center">
        <i class="fas fa-chart-line mr-2"></i>
        ¿Qué está prediciendo tu modelo?
    </h3>

    <div class="grid md:grid-cols-2 gap-4">
        <div class="bg-white rounded-lg p-4 border-l-4 border-blue-500">
            <p class="text-sm text-gray-600 mb-2">El modelo está prediciendo:</p>
            <p class="text-2xl font-bold text-blue-900">{{ perfil.metricas.target_column }}</p>
        </div>
        <div class="bg-white rounded-lg p-4 border-l-4 border-green-500">
            <p class="text-sm text-gray-600 mb-2">Basándose en:</p>
            <p class="text-sm font-semibold text-green-900">{{ perfil.metricas.feature_columns|length }} variables predictoras</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Metrics Dashboard -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    {% for metrica, valor in perfil.metricas.items %}
        {% if metrica not in "ROC_FPR,ROC_TPR,Confusion_Matrix,Feature_Importance,Feature_Coefficients,target_column,feature_columns" %}
        <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide">{{ metrica }}</h3>
                <div class="w-8 h-8 bg-gradient-to-r from-purple-400 to-pink-500 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-bar text-white text-sm"></i>
                </div>
            </div>

            {% if metrica == "R2 Score" or metrica == "Accuracy" %}
                <p class="text-3xl font-bold text-gray-800 mb-2">{{ valor|floatformat:4 }}</p>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    {% widthratio valor 1 100 as percentage %}
                    <div class="bg-gradient-to-r from-purple-400 to-pink-500 h-2 rounded-full transition-all duration-500"
                         style="width: {{ percentage }}%"></div>
                </div>
            {% elif metrica == "AUC" %}
                <p class="text-3xl font-bold text-gray-800 mb-2">{{ valor|floatformat:4 }}</p>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    {% widthratio valor 1 100 as auc_percentage %}
                    <div class="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full transition-all duration-500"
                         style="width: {{ auc_percentage }}%"></div>
                </div>
            {% else %}
                <p class="text-3xl font-bold text-gray-800 mb-2">
                    {% if valor > 1000 %}
                        {{ valor|floatformat:2 }}
                    {% elif valor > 10 %}
                        {{ valor|floatformat:2 }}
                    {% else %}
                        {{ valor|floatformat:4 }}
                    {% endif %}
                </p>
            {% endif %}
        </div>
        {% endif %}
    {% endfor %}
</div>

<!-- Visualization Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Confusion Matrix -->
    <div class="bg-white rounded-2xl p-6 shadow-lg">
        <h3 class="text-xl font-bold mb-6 flex items-center">
            <i class="fas fa-table mr-3 text-blue-500"></i>
            Matriz de Confusión
        </h3>
        <div class="h-80 flex items-center justify-center">
            <canvas id="confusionMatrix"></canvas>
        </div>
    </div>

    <!-- Learning Curve -->
    <div class="bg-white rounded-2xl p-6 shadow-lg">
        <h3 class="text-xl font-bold mb-6 flex items-center">
            <i class="fas fa-chart-line mr-3 text-green-500"></i>
            Curva de Aprendizaje
        </h3>
        <div class="h-80 flex items-center justify-center">
            <canvas id="learningCurve"></canvas>
        </div>
    </div>
</div>

<!-- Feature Importance -->
<div class="bg-white rounded-2xl p-6 shadow-lg mb-8">
    <h3 class="text-xl font-bold mb-6 flex items-center">
        <i class="fas fa-weight-hanging mr-3 text-purple-500"></i>
        Importancia de Características
    </h3>
    <div class="h-80">
        <canvas id="featureImportance"></canvas>
    </div>
</div>

<!-- ROC Curve and Precision-Recall -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-white rounded-2xl p-6 shadow-lg">
        <h3 class="text-xl font-bold mb-6 flex items-center">
            <i class="fas fa-crosshairs mr-3 text-red-500"></i>
            Curva ROC
        </h3>
        <div class="h-80">
            <canvas id="rocCurve"></canvas>
        </div>
    </div>

    <div class="bg-white rounded-2xl p-6 shadow-lg">
        <h3 class="text-xl font-bold mb-6 flex items-center">
            <i class="fas fa-bullseye mr-3 text-orange-500"></i>
            Precisión vs Recall
        </h3>
        <div class="h-80">
            <canvas id="precisionRecall"></canvas>
        </div>
    </div>
</div>
{% else %}
<!-- No Results State -->
<div class="bg-white rounded-2xl p-12 shadow-lg text-center">
    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-chart-line text-4xl text-gray-400"></i>
    </div>
    <h3 class="text-2xl font-bold text-gray-800 mb-4">No hay resultados disponibles</h3>
    <p class="text-gray-600 mb-8 max-w-md mx-auto">
        Para ver métricas y visualizaciones, primero necesitas entrenar tu modelo con un dataset.
    </p>

    <div class="flex flex-col sm:flex-row gap-4 justify-center">
        {% if not perfil.dataset_nombre %}
            <a href="{% url 'dashboard_datos' perfil.id %}" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                <i class="fas fa-upload mr-2"></i>Subir Dataset
            </a>
        {% endif %}

        {% if perfil.dataset_nombre and not perfil.algoritmo_elegido %}
            <a href="{% url 'dashboard_modelo' perfil.id %}" class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors">
                <i class="fas fa-robot mr-2"></i>Configurar Modelo
            </a>
        {% endif %}

        {% if perfil.dataset_nombre and perfil.algoritmo_elegido %}
            <a href="{% url 'dashboard_modelo' perfil.id %}" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                <i class="fas fa-play mr-2"></i>Entrenar Modelo
            </a>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Export and Actions -->
<div class="bg-white rounded-2xl p-6 shadow-lg">
    <h3 class="text-xl font-bold mb-6 flex items-center">
        <i class="fas fa-download mr-3 text-indigo-500"></i>
        Exportar Resultados
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <button class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all group">
            <div class="text-center">
                <i class="fas fa-file-pdf text-2xl text-gray-400 group-hover:text-blue-500 mb-2"></i>
                <p class="font-medium text-gray-600 group-hover:text-blue-700">Reporte PDF</p>
            </div>
        </button>

        <button class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-green-500 hover:bg-green-50 transition-all group">
            <div class="text-center">
                <i class="fas fa-file-excel text-2xl text-gray-400 group-hover:text-green-500 mb-2"></i>
                <p class="font-medium text-gray-600 group-hover:text-green-700">Datos Excel</p>
            </div>
        </button>

        <button class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all group">
            <div class="text-center">
                <i class="fas fa-code text-2xl text-gray-400 group-hover:text-purple-500 mb-2"></i>
                <p class="font-medium text-gray-600 group-hover:text-purple-700">Código Python</p>
            </div>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if perfil.metricas %}
    // Confusion Matrix Chart
    const confusionCtx = document.getElementById('confusionMatrix');
    if (confusionCtx) {
        {% if perfil.metricas.Confusion_Matrix %}
        const cm = {{ perfil.metricas.Confusion_Matrix|safe }};

        // Aplanar matriz de confusión
        let confusionData = [];
        let confusionLabels = [];

        if (cm.length === 2) {
            // Matriz 2x2 (clasificación binaria)
            confusionData = [cm[1][1], cm[0][1], cm[0][0], cm[1][0]];
            confusionLabels = ['Verdadero Positivo', 'Falso Positivo', 'Verdadero Negativo', 'Falso Negativo'];
        } else {
            // Matriz nxn (clasificación multi-clase)
            for (let i = 0; i < cm.length; i++) {
                for (let j = 0; j < cm[i].length; j++) {
                    confusionLabels.push(`Real ${i} → Pred ${j}`);
                    confusionData.push(cm[i][j]);
                }
            }
        }

        new Chart(confusionCtx, {
            type: 'bar',
            data: {
                labels: confusionLabels,
                datasets: [{
                    label: 'Cantidad',
                    data: confusionData,
                    backgroundColor: confusionLabels.map((label, i) =>
                        label.includes('Verdadero') ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)'
                    ),
                    borderColor: confusionLabels.map((label, i) =>
                        label.includes('Verdadero') ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'
                    ),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Matriz de Confusión'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Cantidad de Predicciones'
                        }
                    }
                }
            }
        });
        {% else %}
        confusionCtx.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400"><p>No disponible para este modelo</p></div>';
        {% endif %}
    }

    // Learning Curve Chart
    const learningCtx = document.getElementById('learningCurve');
    if (learningCtx) {
        new Chart(learningCtx, {
            type: 'line',
            data: {
                labels: ['Época 1', 'Época 2', 'Época 3', 'Época 4', 'Época 5', 'Época 6'],
                datasets: [{
                    label: 'Entrenamiento',
                    data: [0.6, 0.75, 0.82, 0.87, 0.89, 0.91],
                    borderColor: 'rgb(99, 102, 241)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Validación',
                    data: [0.58, 0.72, 0.79, 0.84, 0.86, 0.88],
                    borderColor: 'rgb(236, 72, 153)',
                    backgroundColor: 'rgba(236, 72, 153, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1
                    }
                }
            }
        });
    }

    // Feature Importance Chart
    const featureCtx = document.getElementById('featureImportance');
    if (featureCtx) {
        {% if perfil.metricas.Feature_Importance %}
        const featureData = {{ perfil.metricas.Feature_Importance|safe }};

        new Chart(featureCtx, {
            type: 'bar',
            data: {
                labels: featureData.features,
                datasets: [{
                    label: 'Importancia',
                    data: featureData.importances,
                    backgroundColor: 'rgba(147, 51, 234, 0.8)',
                    borderColor: 'rgb(147, 51, 234)',
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Importancia de Características del Modelo'
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Importancia'
                        }
                    }
                }
            }
        });
        {% elif perfil.metricas.Feature_Coefficients %}
        const coeffData = {{ perfil.metricas.Feature_Coefficients|safe }};

        new Chart(featureCtx, {
            type: 'bar',
            data: {
                labels: coeffData.features,
                datasets: [{
                    label: 'Coeficiente',
                    data: coeffData.coefficients,
                    backgroundColor: coeffData.coefficients.map(c => c >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                    borderColor: coeffData.coefficients.map(c => c >= 0 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'),
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Coeficientes del Modelo'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Valor del Coeficiente'
                        }
                    }
                }
            }
        });
        {% else %}
        featureCtx.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400"><p>No disponible para este modelo</p></div>';
        {% endif %}
    }

    // ROC Curve
    const rocCtx = document.getElementById('rocCurve');
    if (rocCtx) {
        {% if perfil.metricas.ROC_FPR and perfil.metricas.ROC_TPR %}
        const rocFpr = {{ perfil.metricas.ROC_FPR|safe }};
        const rocTpr = {{ perfil.metricas.ROC_TPR|safe }};
        const rocAuc = {{ perfil.metricas.AUC|default:0 }};

        new Chart(rocCtx, {
            type: 'line',
            data: {
                labels: rocFpr,
                datasets: [{
                    label: `ROC Curve (AUC = ${rocAuc.toFixed(3)})`,
                    data: rocTpr,
                    borderColor: 'rgb(249, 115, 22)',
                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                    tension: 0.1,
                    fill: true,
                    pointRadius: 0
                }, {
                    label: 'Línea Base',
                    data: rocFpr.map(x => x),
                    borderColor: 'rgb(75, 85, 99)',
                    borderDash: [5, 5],
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Curva ROC - Receiver Operating Characteristic'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Tasa de Falsos Positivos (FPR)'
                        },
                        min: 0,
                        max: 1
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Tasa de Verdaderos Positivos (TPR)'
                        },
                        min: 0,
                        max: 1
                    }
                }
            }
        });
        {% else %}
        rocCtx.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400"><p>No disponible para este modelo</p></div>';
        {% endif %}
    }

    // Precision-Recall Curve
    const prCtx = document.getElementById('precisionRecall');
    if (prCtx) {
        new Chart(prCtx, {
            type: 'line',
            data: {
                labels: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0],
                datasets: [{
                    label: 'Precisión vs Recall',
                    data: [1.0, 0.95, 0.92, 0.88, 0.85, 0.80, 0.75, 0.68, 0.60, 0.50, 0.40],
                    borderColor: 'rgb(249, 115, 22)',
                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Recall'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Precisión'
                        }
                    }
                }
            }
        });
    }
    {% endif %}

    // Export functionality
    document.querySelectorAll('button[class*="group"]').forEach(button => {
        button.addEventListener('click', function() {
            const text = this.querySelector('p').textContent;
            console.log(`Exportando: ${text}`);
            // Implement export logic here
        });
    });
});
</script>
{% endblock %}